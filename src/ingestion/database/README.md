# Symbology Database

This package contains the database models and CRUD operations for the Symbology system.

## Overview

The database layer is built using SQLAlchemy's modern declarative mapping pattern with typing support. All models inherit from a common `Base` class and use the `Mapped` types to define their attributes.

## Models

The database includes the following models:

- **Company**: Represents companies with their identifiers (CIK, EIN) and attributes such as name, tickers, exchanges, SIC codes, fiscal year end dates, entity types, and former names.
- **Filing**: SEC filings submitted by companies, including accession numbers, filing types, filing dates, filing URLs, and periods of report.
- **Document**: Documents contained within filings, including document names and content.
- **FinancialConcept**: Financial reporting concepts used in data analysis, with names, descriptions, and labels.
- **FinancialValue**: Actual financial data points for companies, linking companies to financial concepts with numerical values and dates.
- **Completion**: AI completions generated by the system, including model, temperature, top_p, and context text.
- **Rating**: User feedback on AI completions, including content scores, format scores, comments, and tags.
- **Prompt**: Templates for AI prompts with different roles (system, user, assistant), including templates and variables.

## Relationships

The models have the following key relationships:

- A **Company** has many **Filings**, **Documents**, and **FinancialValues** (one-to-many relationships with cascade delete)
- A **Filing** belongs to a **Company** (many-to-one) and has many **Documents** and **FinancialValues** (one-to-many with cascade delete)
- A **Document** belongs to a **Company** (many-to-one) and optionally to a **Filing** (many-to-one optional), and can be linked to many **Completions** (many-to-many)
- A **FinancialValue** links a **Company** to a **FinancialConcept** (many-to-one relationships) and optionally to a **Filing** (many-to-one optional)
- A **Completion** has many **Ratings** (one-to-many), is associated with **Documents** (many-to-many), and can be linked to **Prompts** as either a system or user prompt (many-to-one relationships)
- A **Rating** belongs to a **Completion** (many-to-one with cascade delete)
- A **Prompt** can be linked to **Completions** as either a system prompt or user prompt (one-to-many relationships)

## Database Functions

Each model has a corresponding set of CRUD functions:

- `get_<model>_ids()`: Retrieve all IDs for a model
- `get_<model>(id)`: Get a specific instance by ID
- `create_<model>(data)`: Create a new instance
- `update_<model>(id, data)`: Update an existing instance
- `delete_<model>(id)`: Delete an instance

## Setup and Usage

The database is initialized using the `init_db` function from `base.py`, which requires a connection URL. After initialization, you can access the database session using `get_db_session()` for standard operations or `get_db()` for FastAPI dependency injection.

Example:

```python
from src.ingestion.database import init_db, get_company, create_company

# Initialize the database
init_db("postgresql://user:password@localhost/symbology")

# Create a company
company = create_company({
    "name": "Example Corp",
    "cik": "0000123456",
    "tickers": ["EXPL"],
    "exchanges": ["NYSE"]
})

# Retrieve a company
retrieved_company = get_company(company.id)
```

## Error Handling

All database functions include error handling and logging. Errors are logged using the structured logger and exceptions are re-raised to be handled by the caller.

## Validation

Database models include validation of input data:
- Ratings validate that score ranges are between 1-10
- Unique constraints are enforced on company CIK, EIN, and filing accession numbers
- Relationship integrity is maintained through foreign key constraints

## JSON and Data Types

Several models support JSON storage for complex data:
- Completions store context text as JSON
- Companies store former names as JSON
- Prompts store template variables and default values as JSON
